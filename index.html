<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>International Address Locator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-2 flex items-center gap-2">
            <i class="fas fa-map-pin text-indigo-600"></i>
            International Address Locator
        </h1>
        <p class="text-gray-600 mb-8">Enter your address to find it on the map</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Form Section -->
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Address Details</h2>
                
                <div class="space-y-4">
                    <!-- Country Dropdown -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Country
                        </label>
                        <div class="relative">
                            <button
                                id="countryButton"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-left flex items-center justify-between bg-white hover:bg-gray-50 transition"
                            >
                                <span id="selectedCountryName">United States</span>
                                <i class="fas fa-chevron-down text-gray-500"></i>
                            </button>
                            
                            <div id="countryDropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg">
                                <input
                                    type="text"
                                    id="countrySearch"
                                    placeholder="Search countries..."
                                    class="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                                />
                                <div id="countryList" class="max-h-64 overflow-y-auto">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="countryCode" value="US">
                        <input type="hidden" id="divisionLabel" value="State">
                    </div>

                    <!-- Street Address -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Street Address
                        </label>
                        <input
                            type="text"
                            id="street"
                            placeholder="123 Main Street"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        />
                    </div>

                    <!-- City and State/Province -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                City
                            </label>
                            <div class="relative">
                                <input
                                    type="text"
                                    id="city"
                                    placeholder="New York"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                />
                                <div id="cityDropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg">
                                    <input
                                        type="text"
                                        id="citySearch"
                                        placeholder="Search cities..."
                                        class="w-full px-4 py-2 border-b border-gray-300 focus:outline-none rounded-t-lg"
                                    />
                                    <div id="cityList" class="max-h-48 overflow-y-auto">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <span id="cityHint" class="text-xs text-gray-400 mt-1 block"></span>
                        </div>
                        <div>
                            <label id="stateLabel" class="block text-sm font-medium text-gray-700 mb-2">
                                State
                            </label>
                            <div class="relative">
                                <input
                                    type="text"
                                    id="state"
                                    placeholder="NY"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                />
                                <div id="stateDropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg">
                                    <input
                                        type="text"
                                        id="stateSearch"
                                        placeholder="Search states..."
                                        class="w-full px-4 py-2 border-b border-gray-300 focus:outline-none rounded-t-lg"
                                    />
                                    <div id="stateList" class="max-h-48 overflow-y-auto">
                                        <!-- Populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <span id="statePlaceholderHint" class="text-xs text-gray-400 mt-1 block"></span>
                        </div>
                    </div>

                    <!-- Postal Code -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Postal Code
                        </label>
                        <input
                            type="text"
                            id="postalCode"
                            placeholder="10001"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        />
                    </div>

                    <!-- Auto-geocode hint -->
                    <div class="text-xs text-gray-500 italic">
                        ðŸ’¡ Tip: Click on the state field to see available options, then select a city. Address fields auto-update the map on blur.
                    </div>

                    <!-- Find on Map Button -->
                    <button
                        id="geocodeBtn"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2 mt-6"
                    >
                        <i class="fas fa-search"></i>
                        <span id="gecodeBtnText">Find on Map</span>
                    </button>
                </div>

                <!-- Coordinates Display -->
                <div class="mt-8 pt-8 border-t border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-4">Coordinates</h3>
                    <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm">
                        <div class="text-gray-600">
                            <span class="font-semibold text-indigo-600">Latitude:</span>
                            <span id="latitude">40.712776</span>
                        </div>
                        <div class="text-gray-600 mt-2">
                            <span class="font-semibold text-indigo-600">Longitude:</span>
                            <span id="longitude">-74.005974</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Section -->
            <div class="bg-white rounded-lg shadow-lg p-8 flex flex-col">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Map View</h2>
                
                <iframe
                    id="mapFrame"
                    src="https://www.openstreetmap.org/export/embed.html?bbox=-74.056&layer=mapnik&marker=40.712776,-74.005974"
                    style="width: 100%; height: 100%; border: none; min-height: 384px;"
                    class="flex-1 rounded-lg overflow-hidden border-2 border-indigo-200 mb-4"
                    allowFullScreen=""
                    loading="lazy"
                    referrerPolicy="no-referrer-when-downgrade"
                ></iframe>

                <div class="bg-indigo-50 rounded-lg p-4">
                    <p class="text-sm text-gray-700">
                        <span class="font-semibold text-indigo-600">Current Location:</span>
                        <br class="mt-1" />
                        <span id="locationText">New York, NY, USA</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-gray-700">
            <p>
                <span class="font-semibold text-blue-600">How it works:</span> Select your country (195+ supported) - a searchable list of states/provinces/regions automatically loads. Click on the state field to see all available options or search by name. When you select a state, a city list appears for that location. The form updates the map in real-time. Click outside address fields to automatically find and display them on the map with live coordinates.
            </p>
        </div>
    </div>

    <script>
        // Country data with division labels
        const COUNTRIES = [
            { code: 'AF', name: 'Afghanistan', divisionLabel: 'Province' },
            { code: 'AL', name: 'Albania', divisionLabel: 'District' },
            { code: 'DZ', name: 'Algeria', divisionLabel: 'Province' },
            { code: 'AD', name: 'Andorra', divisionLabel: 'Parish' },
            { code: 'AO', name: 'Angola', divisionLabel: 'Province' },
            { code: 'AR', name: 'Argentina', divisionLabel: 'Province' },
            { code: 'AU', name: 'Australia', divisionLabel: 'State' },
            { code: 'AT', name: 'Austria', divisionLabel: 'State' },
            { code: 'AZ', name: 'Azerbaijan', divisionLabel: 'Region' },
            { code: 'BS', name: 'Bahamas', divisionLabel: 'District' },
            { code: 'BH', name: 'Bahrain', divisionLabel: 'Governorate' },
            { code: 'BD', name: 'Bangladesh', divisionLabel: 'Division' },
            { code: 'BB', name: 'Barbados', divisionLabel: 'Parish' },
            { code: 'BY', name: 'Belarus', divisionLabel: 'Region' },
            { code: 'BE', name: 'Belgium', divisionLabel: 'Region' },
            { code: 'BZ', name: 'Belize', divisionLabel: 'District' },
            { code: 'BJ', name: 'Benin', divisionLabel: 'Department' },
            { code: 'BT', name: 'Bhutan', divisionLabel: 'District' },
            { code: 'BO', name: 'Bolivia', divisionLabel: 'Department' },
            { code: 'BA', name: 'Bosnia and Herzegovina', divisionLabel: 'Entity' },
            { code: 'BW', name: 'Botswana', divisionLabel: 'District' },
            { code: 'BR', name: 'Brazil', divisionLabel: 'State' },
            { code: 'BN', name: 'Brunei', divisionLabel: 'District' },
            { code: 'BG', name: 'Bulgaria', divisionLabel: 'Province' },
            { code: 'BF', name: 'Burkina Faso', divisionLabel: 'Region' },
            { code: 'BI', name: 'Burundi', divisionLabel: 'Province' },
            { code: 'KH', name: 'Cambodia', divisionLabel: 'Province' },
            { code: 'CM', name: 'Cameroon', divisionLabel: 'Region' },
            { code: 'CA', name: 'Canada', divisionLabel: 'Province/Territory' },
            { code: 'CV', name: 'Cape Verde', divisionLabel: 'Municipality' },
            { code: 'CF', name: 'Central African Republic', divisionLabel: 'Province' },
            { code: 'TD', name: 'Chad', divisionLabel: 'Region' },
            { code: 'CL', name: 'Chile', divisionLabel: 'Region' },
            { code: 'CN', name: 'China', divisionLabel: 'Province' },
            { code: 'CO', name: 'Colombia', divisionLabel: 'Department' },
            { code: 'KM', name: 'Comoros', divisionLabel: 'Island' },
            { code: 'CG', name: 'Congo', divisionLabel: 'Department' },
            { code: 'CD', name: 'Congo (Democratic Republic)', divisionLabel: 'Province' },
            { code: 'CR', name: 'Costa Rica', divisionLabel: 'Province' },
            { code: 'HR', name: 'Croatia', divisionLabel: 'County' },
            { code: 'CU', name: 'Cuba', divisionLabel: 'Province' },
            { code: 'CY', name: 'Cyprus', divisionLabel: 'District' },
            { code: 'CZ', name: 'Czech Republic', divisionLabel: 'Region' },
            { code: 'DK', name: 'Denmark', divisionLabel: 'Region' },
            { code: 'DJ', name: 'Djibouti', divisionLabel: 'District' },
            { code: 'DM', name: 'Dominica', divisionLabel: 'Parish' },
            { code: 'DO', name: 'Dominican Republic', divisionLabel: 'Province' },
            { code: 'EC', name: 'Ecuador', divisionLabel: 'Province' },
            { code: 'EG', name: 'Egypt', divisionLabel: 'Governorate' },
            { code: 'SV', name: 'El Salvador', divisionLabel: 'Department' },
            { code: 'GQ', name: 'Equatorial Guinea', divisionLabel: 'Province' },
            { code: 'ER', name: 'Eritrea', divisionLabel: 'Region' },
            { code: 'EE', name: 'Estonia', divisionLabel: 'County' },
            { code: 'ET', name: 'Ethiopia', divisionLabel: 'Region' },
            { code: 'FJ', name: 'Fiji', divisionLabel: 'Division' },
            { code: 'FI', name: 'Finland', divisionLabel: 'Region' },
            { code: 'FR', name: 'France', divisionLabel: 'Region' },
            { code: 'GA', name: 'Gabon', divisionLabel: 'Province' },
            { code: 'GM', name: 'Gambia', divisionLabel: 'Division' },
            { code: 'GE', name: 'Georgia', divisionLabel: 'Region' },
            { code: 'DE', name: 'Germany', divisionLabel: 'State' },
            { code: 'GH', name: 'Ghana', divisionLabel: 'Region' },
            { code: 'GR', name: 'Greece', divisionLabel: 'Region' },
            { code: 'GD', name: 'Grenada', divisionLabel: 'Parish' },
            { code: 'GT', name: 'Guatemala', divisionLabel: 'Department' },
            { code: 'GN', name: 'Guinea', divisionLabel: 'Region' },
            { code: 'GW', name: 'Guinea-Bissau', divisionLabel: 'Region' },
            { code: 'GY', name: 'Guyana', divisionLabel: 'Region' },
            { code: 'HT', name: 'Haiti', divisionLabel: 'Department' },
            { code: 'HN', name: 'Honduras', divisionLabel: 'Department' },
            { code: 'HU', name: 'Hungary', divisionLabel: 'County' },
            { code: 'IS', name: 'Iceland', divisionLabel: 'Region' },
            { code: 'IN', name: 'India', divisionLabel: 'State' },
            { code: 'ID', name: 'Indonesia', divisionLabel: 'Province' },
            { code: 'IR', name: 'Iran', divisionLabel: 'Province' },
            { code: 'IQ', name: 'Iraq', divisionLabel: 'Governorate' },
            { code: 'IE', name: 'Ireland', divisionLabel: 'County' },
            { code: 'IL', name: 'Israel', divisionLabel: 'District' },
            { code: 'IT', name: 'Italy', divisionLabel: 'Region' },
            { code: 'CI', name: 'Ivory Coast', divisionLabel: 'Region' },
            { code: 'JM', name: 'Jamaica', divisionLabel: 'Parish' },
            { code: 'JP', name: 'Japan', divisionLabel: 'Prefecture' },
            { code: 'JO', name: 'Jordan', divisionLabel: 'Governorate' },
            { code: 'KZ', name: 'Kazakhstan', divisionLabel: 'Region' },
            { code: 'KE', name: 'Kenya', divisionLabel: 'County' },
            { code: 'KI', name: 'Kiribati', divisionLabel: 'Atoll' },
            { code: 'KP', name: 'Korea (North)', divisionLabel: 'Province' },
            { code: 'KR', name: 'Korea (South)', divisionLabel: 'Province' },
            { code: 'KW', name: 'Kuwait', divisionLabel: 'Governorate' },
            { code: 'KG', name: 'Kyrgyzstan', divisionLabel: 'Region' },
            { code: 'LA', name: 'Laos', divisionLabel: 'Province' },
            { code: 'LV', name: 'Latvia', divisionLabel: 'Region' },
            { code: 'LB', name: 'Lebanon', divisionLabel: 'Governorate' },
            { code: 'LS', name: 'Lesotho', divisionLabel: 'District' },
            { code: 'LR', name: 'Liberia', divisionLabel: 'County' },
            { code: 'LY', name: 'Libya', divisionLabel: 'Region' },
            { code: 'LI', name: 'Liechtenstein', divisionLabel: 'Municipality' },
            { code: 'LT', name: 'Lithuania', divisionLabel: 'County' },
            { code: 'LU', name: 'Luxembourg', divisionLabel: 'District' },
            { code: 'MG', name: 'Madagascar', divisionLabel: 'Region' },
            { code: 'MW', name: 'Malawi', divisionLabel: 'District' },
            { code: 'MY', name: 'Malaysia', divisionLabel: 'State' },
            { code: 'MV', name: 'Maldives', divisionLabel: 'Atoll' },
            { code: 'ML', name: 'Mali', divisionLabel: 'Region' },
            { code: 'MT', name: 'Malta', divisionLabel: 'District' },
            { code: 'MH', name: 'Marshall Islands', divisionLabel: 'Atoll' },
            { code: 'MR', name: 'Mauritania', divisionLabel: 'Region' },
            { code: 'MU', name: 'Mauritius', divisionLabel: 'District' },
            { code: 'MX', name: 'Mexico', divisionLabel: 'State' },
            { code: 'FM', name: 'Micronesia', divisionLabel: 'State' },
            { code: 'MD', name: 'Moldova', divisionLabel: 'District' },
            { code: 'MC', name: 'Monaco', divisionLabel: 'Quarter' },
            { code: 'MN', name: 'Mongolia', divisionLabel: 'Province' },
            { code: 'ME', name: 'Montenegro', divisionLabel: 'Municipality' },
            { code: 'MA', name: 'Morocco', divisionLabel: 'Region' },
            { code: 'MZ', name: 'Mozambique', divisionLabel: 'Province' },
            { code: 'MM', name: 'Myanmar', divisionLabel: 'Region' },
            { code: 'NA', name: 'Namibia', divisionLabel: 'Region' },
            { code: 'NR', name: 'Nauru', divisionLabel: 'District' },
            { code: 'NP', name: 'Nepal', divisionLabel: 'Province' },
            { code: 'NL', name: 'Netherlands', divisionLabel: 'Province' },
            { code: 'NZ', name: 'New Zealand', divisionLabel: 'Region' },
            { code: 'NI', name: 'Nicaragua', divisionLabel: 'Department' },
            { code: 'NE', name: 'Niger', divisionLabel: 'Region' },
            { code: 'NG', name: 'Nigeria', divisionLabel: 'State' },
            { code: 'NO', name: 'Norway', divisionLabel: 'County' },
            { code: 'OM', name: 'Oman', divisionLabel: 'Governorate' },
            { code: 'PK', name: 'Pakistan', divisionLabel: 'Province' },
            { code: 'PW', name: 'Palau', divisionLabel: 'State' },
            { code: 'PA', name: 'Panama', divisionLabel: 'Province' },
            { code: 'PG', name: 'Papua New Guinea', divisionLabel: 'Province' },
            { code: 'PY', name: 'Paraguay', divisionLabel: 'Department' },
            { code: 'PE', name: 'Peru', divisionLabel: 'Region' },
            { code: 'PH', name: 'Philippines', divisionLabel: 'Region' },
            { code: 'PL', name: 'Poland', divisionLabel: 'Voivodeship' },
            { code: 'PT', name: 'Portugal', divisionLabel: 'District' },
            { code: 'QA', name: 'Qatar', divisionLabel: 'Municipality' },
            { code: 'RO', name: 'Romania', divisionLabel: 'County' },
            { code: 'RU', name: 'Russia', divisionLabel: 'Region' },
            { code: 'RW', name: 'Rwanda', divisionLabel: 'District' },
            { code: 'KN', name: 'Saint Kitts and Nevis', divisionLabel: 'Parish' },
            { code: 'LC', name: 'Saint Lucia', divisionLabel: 'Quarter' },
            { code: 'VC', name: 'Saint Vincent and the Grenadines', divisionLabel: 'Parish' },
            { code: 'WS', name: 'Samoa', divisionLabel: 'District' },
            { code: 'SM', name: 'San Marino', divisionLabel: 'Castle' },
            { code: 'ST', name: 'SÃ£o TomÃ© and PrÃ­ncipe', divisionLabel: 'District' },
            { code: 'SA', name: 'Saudi Arabia', divisionLabel: 'Region' },
            { code: 'SN', name: 'Senegal', divisionLabel: 'Region' },
            { code: 'RS', name: 'Serbia', divisionLabel: 'District' },
            { code: 'SC', name: 'Seychelles', divisionLabel: 'District' },
            { code: 'SL', name: 'Sierra Leone', divisionLabel: 'District' },
            { code: 'SG', name: 'Singapore', divisionLabel: 'District' },
            { code: 'SK', name: 'Slovakia', divisionLabel: 'Region' },
            { code: 'SI', name: 'Slovenia', divisionLabel: 'Region' },
            { code: 'SB', name: 'Solomon Islands', divisionLabel: 'Province' },
            { code: 'SO', name: 'Somalia', divisionLabel: 'Region' },
            { code: 'ZA', name: 'South Africa', divisionLabel: 'Province' },
            { code: 'SS', name: 'South Sudan', divisionLabel: 'State' },
            { code: 'ES', name: 'Spain', divisionLabel: 'Autonomous Community' },
            { code: 'LK', name: 'Sri Lanka', divisionLabel: 'District' },
            { code: 'SD', name: 'Sudan', divisionLabel: 'State' },
            { code: 'SR', name: 'Suriname', divisionLabel: 'District' },
            { code: 'SE', name: 'Sweden', divisionLabel: 'County' },
            { code: 'CH', name: 'Switzerland', divisionLabel: 'Canton' },
            { code: 'SY', name: 'Syria', divisionLabel: 'Governorate' },
            { code: 'TW', name: 'Taiwan', divisionLabel: 'County' },
            { code: 'TJ', name: 'Tajikistan', divisionLabel: 'Region' },
            { code: 'TZ', name: 'Tanzania', divisionLabel: 'Region' },
            { code: 'TH', name: 'Thailand', divisionLabel: 'Province' },
            { code: 'TL', name: 'Timor-Leste', divisionLabel: 'District' },
            { code: 'TG', name: 'Togo', divisionLabel: 'Region' },
            { code: 'TO', name: 'Tonga', divisionLabel: 'Division' },
            { code: 'TT', name: 'Trinidad and Tobago', divisionLabel: 'Region' },
            { code: 'TN', name: 'Tunisia', divisionLabel: 'Governorate' },
            { code: 'TR', name: 'Turkey', divisionLabel: 'Province' },
            { code: 'TM', name: 'Turkmenistan', divisionLabel: 'Region' },
            { code: 'TV', name: 'Tuvalu', divisionLabel: 'District' },
            { code: 'UG', name: 'Uganda', divisionLabel: 'District' },
            { code: 'UA', name: 'Ukraine', divisionLabel: 'Oblast' },
            { code: 'AE', name: 'United Arab Emirates', divisionLabel: 'Emirate' },
            { code: 'GB', name: 'United Kingdom', divisionLabel: 'County' },
            { code: 'US', name: 'United States', divisionLabel: 'State' },
            { code: 'UY', name: 'Uruguay', divisionLabel: 'Department' },
            { code: 'UZ', name: 'Uzbekistan', divisionLabel: 'Region' },
            { code: 'VU', name: 'Vanuatu', divisionLabel: 'Province' },
            { code: 'VA', name: 'Vatican City', divisionLabel: 'Ward' },
            { code: 'VE', name: 'Venezuela', divisionLabel: 'State' },
            { code: 'VN', name: 'Vietnam', divisionLabel: 'Province' },
            { code: 'YE', name: 'Yemen', divisionLabel: 'Governorate' },
            { code: 'ZM', name: 'Zambia', divisionLabel: 'Province' },
            { code: 'ZW', name: 'Zimbabwe', divisionLabel: 'Province' }
        ];

        // DOM Elements
        const countryButton = document.getElementById('countryButton');
        const countryDropdown = document.getElementById('countryDropdown');
        const countrySearch = document.getElementById('countrySearch');
        const countryList = document.getElementById('countryList');
        const countryCode = document.getElementById('countryCode');
        const divisionLabel = document.getElementById('divisionLabel');
        const selectedCountryName = document.getElementById('selectedCountryName');
        const stateLabel = document.getElementById('stateLabel');
        const stateInput = document.getElementById('state');
        const stateDropdown = document.getElementById('stateDropdown');
        const stateSearch = document.getElementById('stateSearch');
        const stateList = document.getElementById('stateList');
        const statePlaceholderHint = document.getElementById('statePlaceholderHint');
        const geocodeBtn = document.getElementById('geocodeBtn');
        const streetInput = document.getElementById('street');
        const cityInput = document.getElementById('city');
        const cityDropdown = document.getElementById('cityDropdown');
        const citySearch = document.getElementById('citySearch');
        const cityList = document.getElementById('cityList');
        const cityHint = document.getElementById('cityHint');
        const postalCodeInput = document.getElementById('postalCode');
        const latitudeSpan = document.getElementById('latitude');
        const longitudeSpan = document.getElementById('longitude');
        const locationText = document.getElementById('locationText');
        const mapFrame = document.getElementById('mapFrame');
        const gecodeBtnText = document.getElementById('gecodeBtnText');

        // Initialize country list
        function initializeCountryList() {
            renderCountries(COUNTRIES);
        }

        // Render country options
        function renderCountries(countries) {
            countryList.innerHTML = '';
            if (countries.length === 0) {
                countryList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No countries found</div>';
                return;
            }
            countries.forEach(country => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `w-full text-left px-4 py-2 hover:bg-indigo-50 transition ${
                    countryCode.value === country.code ? 'bg-indigo-100 font-semibold' : ''
                }`;
                button.innerHTML = `
                    <span class="text-indigo-600 font-mono text-xs mr-2">${country.code}</span>
                    ${country.name}
                `;
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectCountry(country.code, country.name, country.divisionLabel);
                });
                countryList.appendChild(button);
            });
        }

        // Select country
        function selectCountry(code, name, label) {
            countryCode.value = code;
            divisionLabel.value = label;
            selectedCountryName.textContent = name;
            stateLabel.textContent = label;
            countryDropdown.classList.add('hidden');
            countrySearch.value = '';
            renderCountries(COUNTRIES);
            
            // Update placeholder and hint based on division label
            updateStatePlaceholder(label, name);
            
            // Clear state and city when country changes
            stateInput.value = '';
            cityInput.value = '';
            stateDropdown.classList.add('hidden');
            cityDropdown.classList.add('hidden');
            cityHint.textContent = '';
            statePlaceholderHint.textContent = '';
            
            // Fetch states/provinces for this country
            fetchStatesForCountry(code, name);
            
            // Jump to country on map
            jumpToCountry(name);
        }

        // Fetch states/provinces for a country
        function fetchStatesForCountry(countryCode, countryName) {
            statePlaceholderHint.textContent = 'Loading...';
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(countryName)}&limit=100&featuretype=state`)
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        // Get the main country result
                        const countryResult = results[0];
                        
                        // Now search for administrative divisions within this country
                        return fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=${countryCode}&rank_address=8&limit=100`);
                    } else {
                        throw new Error('Country not found');
                    }
                })
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        renderStates(results.slice(0, 30));
                        statePlaceholderHint.textContent = `Found ${results.length} states/regions`;
                    } else {
                        stateList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No states found for this country</div>';
                        statePlaceholderHint.textContent = 'No states/regions available';
                    }
                })
                .catch(error => {
                    console.error('Error fetching states:', error);
                    stateList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">Error loading states</div>';
                    statePlaceholderHint.textContent = 'Error loading states';
                });
        }

        // Render state list
        function renderStates(states) {
            stateList.innerHTML = '';
            if (states.length === 0) {
                stateList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No states found</div>';
                return;
            }
            states.forEach(state => {
                const button = document.createElement('button');
                button.type = 'button';
                const stateName = state.address?.state || state.address?.province || state.address?.region || state.name;
                button.className = 'w-full text-left px-4 py-2 hover:bg-indigo-50 transition border-b border-gray-100 last:border-b-0';
                button.textContent = stateName;
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectState(stateName);
                });
                stateList.appendChild(button);
            });
        }

        // Select state
        function selectState(stateName) {
            stateInput.value = stateName;
            stateDropdown.classList.add('hidden');
            stateSearch.value = '';
            statePlaceholderHint.textContent = '';
            // Fetch cities for this state
            fetchCitiesForStateProvince(stateName);
        }

        // Filter states on search
        stateSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const stateButtons = stateList.querySelectorAll('button');
            let visibleCount = 0;
            
            stateButtons.forEach(button => {
                if (button.textContent.toLowerCase().includes(searchTerm)) {
                    button.style.display = 'block';
                    visibleCount++;
                } else {
                    button.style.display = 'none';
                }
            });

            if (visibleCount === 0) {
                stateList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No states match your search</div>';
            }
        });

        // Close state dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!stateInput.contains(e.target) && !stateDropdown.contains(e.target)) {
                stateDropdown.classList.add('hidden');
            }
        });

        // Open state dropdown on state input focus
        stateInput.addEventListener('focus', () => {
            if (stateList.querySelectorAll('button').length > 0) {
                stateDropdown.classList.remove('hidden');
            }
        });

        // Update state/province placeholder based on division label
        function updateStatePlaceholder(label, countryName) {
            const placeholderMap = {
                'State': 'NY',
                'Province': 'Ontario',
                'Region': 'ÃŽle-de-France',
                'District': 'Westminster',
                'Prefecture': 'Tokyo',
                'County': 'Dublin',
                'Division': 'Dhaka',
                'Governorate': 'Cairo',
                'Department': 'Paris',
                'Parish': 'Kingston',
                'Entity': 'Federation',
                'Municipality': 'Bern',
                'Canton': 'Zurich',
                'Emirate': 'Dubai',
                'Oblast': 'Moscow',
                'Voivodeship': 'Mazovia',
                'Atoll': 'MalÃ©',
                'Castle': 'Serravalle',
                'Quarter': 'Port-au-Prince',
                'Ward': 'Vatikan',
                'Autonomous Community': 'Catalonia',
                'Island': 'Comoros',
                'County/District': 'Kampala',
                'Province/Territory': 'Ontario'
            };

            const placeholder = placeholderMap[label] || label;
            stateInput.placeholder = placeholder;
            const statePlaceholderHint = document.getElementById('statePlaceholderHint');
            statePlaceholderHint.textContent = `e.g., ${placeholder}`;
        }

        // Jump to country on map
        function jumpToCountry(countryName) {
            // Use the Nominatim API to get the bounding box for the country
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(countryName)}&limit=1`)
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        const result = results[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        
                        // Clear the address display when jumping to country
                        locationText.textContent = countryName;
                        latitudeSpan.textContent = lat.toFixed(6);
                        longitudeSpan.textContent = lon.toFixed(6);
                        
                        // Update map to show country
                        const bboxMargin = 2; // Larger zoom out for country view
                        const bbox = `${lon - bboxMargin},${lat - bboxMargin},${lon + bboxMargin},${lat + bboxMargin}`;
                        mapFrame.src = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lon}`;
                    }
                })
                .catch(error => console.error('Error finding country:', error));
        }

        // Auto-geocode on blur
        function attachBlurHandlers() {
            // Special handler for state/province field
            stateInput.addEventListener('blur', () => {
                const state = stateInput.value.trim();
                if (state) {
                    // Jump to state/province on map
                    jumpToStateOrProvince(state);
                }
            });

            // Standard handlers for other address fields
            const otherInputs = [streetInput, cityInput, postalCodeInput];
            
            otherInputs.forEach(input => {
                input.addEventListener('blur', () => {
                    // Only geocode if at least one field has content
                    const street = streetInput.value;
                    const city = cityInput.value;
                    const state = stateInput.value;
                    const postalCode = postalCodeInput.value;

                    if (street || city || state || postalCode) {
                        geocodeAddress();
                    }
                });
            });
        }

        // Fetch cities for state/province
        function fetchCitiesForStateProvince(stateOrProvince) {
            const country = selectedCountryName.textContent;
            const searchQuery = `${stateOrProvince}, ${country}`;

            cityHint.textContent = 'Loading cities...';
            cityDropdown.classList.remove('hidden');

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=50&featuretype=settlement`)
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        // Filter results to get cities/towns in the state
                        const cities = results.filter(result => 
                            result.address && 
                            (result.address.state === stateOrProvince || 
                             result.address.province === stateOrProvince ||
                             result.address.region === stateOrProvince ||
                             result.address.district === stateOrProvince)
                        );

                        if (cities.length === 0) {
                            // If filtering doesn't work, use all results
                            renderCities(results.slice(0, 20));
                            cityHint.textContent = `Showing nearby cities in ${stateOrProvince}`;
                        } else {
                            renderCities(cities.slice(0, 20));
                            cityHint.textContent = `Found ${cities.length} cities in ${stateOrProvince}`;
                        }
                    } else {
                        cityList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No cities found</div>';
                        cityHint.textContent = `No cities found for ${stateOrProvince}`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching cities:', error);
                    cityList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">Error loading cities</div>';
                    cityHint.textContent = 'Error loading cities';
                });
        }

        // Render city list
        function renderCities(cities) {
            cityList.innerHTML = '';
            if (cities.length === 0) {
                cityList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No cities found</div>';
                return;
            }
            cities.forEach(city => {
                const button = document.createElement('button');
                button.type = 'button';
                const cityName = city.address?.city || city.address?.town || city.address?.village || city.name;
                button.className = 'w-full text-left px-4 py-2 hover:bg-indigo-50 transition border-b border-gray-100 last:border-b-0';
                button.textContent = cityName;
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectCity(cityName);
                });
                cityList.appendChild(button);
            });
        }

        // Select city
        function selectCity(cityName) {
            cityInput.value = cityName;
            cityDropdown.classList.add('hidden');
            citySearch.value = '';
            cityHint.textContent = '';
        }

        // Filter cities on search
        citySearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const cityButtons = cityList.querySelectorAll('button');
            let visibleCount = 0;
            
            cityButtons.forEach(button => {
                if (button.textContent.toLowerCase().includes(searchTerm)) {
                    button.style.display = 'block';
                    visibleCount++;
                } else {
                    button.style.display = 'none';
                }
            });

            if (visibleCount === 0) {
                cityList.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No cities match your search</div>';
            }
        });

        // Close city dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!cityInput.contains(e.target) && !cityDropdown.contains(e.target)) {
                cityDropdown.classList.add('hidden');
            }
        });

        // Open city dropdown on city input focus
        cityInput.addEventListener('focus', () => {
            if (stateInput.value.trim()) {
                cityDropdown.classList.remove('hidden');
            }
        });

        // Jump to state/province on map
        function jumpToStateOrProvince(stateOrProvince) {
            const country = selectedCountryName.textContent;
            const searchQuery = `${stateOrProvince}, ${country}`;

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`)
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        const result = results[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        
                        locationText.textContent = result.display_name;
                        latitudeSpan.textContent = lat.toFixed(6);
                        longitudeSpan.textContent = lon.toFixed(6);
                        
                        // Update map to show state/province
                        const bboxMargin = 1; // Medium zoom for state/province view
                        const bbox = `${lon - bboxMargin},${lat - bboxMargin},${lon + bboxMargin},${lat + bboxMargin}`;
                        mapFrame.src = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lon}`;
                    } else {
                        console.error(`Could not find ${stateOrProvince} in ${country}`);
                    }
                })
                .catch(error => console.error('Error finding state/province:', error));
        }

        // Geocode address function
        async function geocodeAddress() {
            const street = streetInput.value;
            const city = cityInput.value;
            const state = stateInput.value;
            const postalCode = postalCodeInput.value;
            const country = selectedCountryName.textContent;

            const addressString = [street, city, state, postalCode, country]
                .filter(Boolean)
                .join(', ');

            if (!addressString.trim()) {
                return;
            }

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addressString)}`
                );
                const results = await response.json();

                if (results.length > 0) {
                    const result = results[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);

                    latitudeSpan.textContent = lat.toFixed(6);
                    longitudeSpan.textContent = lon.toFixed(6);
                    locationText.textContent = result.display_name;

                    // Update map
                    const bboxMargin = 0.05;
                    const bbox = `${lon - bboxMargin},${lat - bboxMargin},${lon + bboxMargin},${lat + bboxMargin}`;
                    mapFrame.src = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lon}`;
                }
            } catch (error) {
                console.error('Error finding address:', error);
            }
        }

        // Toggle country dropdown
        countryButton.addEventListener('click', () => {
            countryDropdown.classList.toggle('hidden');
            if (!countryDropdown.classList.contains('hidden')) {
                countrySearch.focus();
            }
        });

        // Filter countries on search
        countrySearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = COUNTRIES.filter(country =>
                country.name.toLowerCase().includes(searchTerm) ||
                country.code.toLowerCase().includes(searchTerm)
            );
            renderCountries(filtered);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!countryButton.contains(e.target) && !countryDropdown.contains(e.target)) {
                countryDropdown.classList.add('hidden');
            }
        });

        // Geocode address
        geocodeBtn.addEventListener('click', async () => {
            await geocodeAddress();
        });

        // Initialize
        initializeCountryList();
        attachBlurHandlers();
        updateStatePlaceholder('State', 'United States');
        fetchStatesForCountry('US', 'United States');
        jumpToCountry('United States');
    </script>
</body>
</html>